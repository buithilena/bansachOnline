<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/giohang.css}">
    <link rel="icon" type="image/png" th:href="@{/logonewT.png}">
 <style>

     /* Giữ nguyên các kiểu không liên quan */
     body {
         background-color: #f0f4f8;
         font-family: 'Segoe UI', Arial, sans-serif;
         color: #333;
     }

     .cart-container {
         background-color: #fff;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         padding: 20px;
         margin-top: 20px;
         margin-bottom: 20px;
     }

     /* Giới hạn phạm vi cho các phần tử trong giỏ hàng */
     #cart-content .cart-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 15px;
     }

     #cart-content .cart-header h3 {
         font-weight: 600;
         color: #333;
         font-size: 1.25rem;
         margin: 0;
     }

     #cart-content .cart-header .clear-cart {
         color: #dc3545;
         text-decoration: none;
         font-size: 0.85rem;
         transition: color 0.2s ease;
     }

     #cart-content .cart-header .clear-cart:hover {
         color: #c82333;
     }

     #cart-content .cart-item {
         display: flex;
         align-items: center;
         padding: 15px 0;
         border-bottom: 3px solid #d3d6da;
     }

     #cart-content .cart-item:last-child {
         border-bottom: none;
     }

     #cart-content .cart-item-left {
         display: flex;
         align-items: center;
         flex: 1;
     }

     #cart-content .cart-item-right {
         display: flex;
         flex-direction: column;
         align-items: flex-start;
         justify-content: center;
         min-width: 120px;
         margin-left: 15px;
     }

     /* Chỉ áp dụng cho hình ảnh trong giohang.html */
     #cart-content .cart-item img {
         width: 92px;
         height: 92px;
         object-fit: cover;
         border-radius: 8px;
         margin-right: 15px;
         border: 2px solid #d3d6da;
         padding: 2px;
     }

     #cart-content .cart-item-details {
         flex-grow: 1;
         display: flex;
         flex-direction: column;
         gap: 5px;
     }

     #cart-content .cart-item-details h6 {
         font-size: 1rem;
         font-weight: 500;
         color: #333;
         margin: 0;
     }

     #cart-content .cart-item-details .discount-info {
         font-size: 0.8rem;
         color: #28a745;
         margin-top: 5px;
     }

     #cart-content .cart-item-price {
         font-size: 1rem;
         color: #dc3545;
         font-weight: 600;
         text-align: left;
     }

     #cart-content .unit-price {
         font-size: 0.9rem;
         color: #333;
         font-weight: 600;
         text-align: left;
         margin-bottom: 5px;
     }

     #cart-content .quantity-selector {
         display: flex;
         align-items: center;
         border: 1px solid #ced4da;
         border-radius: 4px;
         width: 100px;
         height: 30px;
         justify-content: space-between;
         overflow: hidden;
         margin-right: 10px;
     }

     #cart-content .quantity-selector button {
         background: none;
         border: none;
         padding: 0 10px;
         cursor: pointer;
         font-size: 1rem;
         color: #333;
         height: 100%;
         display: flex;
         justify-content: center;
         transition: background-color 0.2s ease;
     }

     #cart-content .quantity-selector button:hover {
         background-color: #e9ecef;
     }

     #cart-content .quantity-selector input {
         width: 30px;
         text-align: center;
         border: none;
         outline: none;
         background: none;
         font-size: 0.9rem;
         color: #333;
         height: 100%;
         padding: 0;
     }

     #cart-content .unit-selector {
         height: 30px;
         font-size: 0.85rem;
         border-radius: 4px;
         border: 1px solid #ced4da;
         padding: 0 5px;
         margin-right: 10px;
     }

     #cart-content .cart-item-actions {
         display: flex;
         align-items: center;
         gap: 10px;
     }

     #cart-content .btn-remove {
         color: #6c757d;
         border: none;
         background: none;
         font-size: 1.2rem;
         transition: color 0.2s ease;
     }

     #cart-content .btn-remove:hover {
         color: #dc3545;
     }

     #cart-content .cart-summary {
         padding: 15px;
         background-color: #f8f9fa;
         border-radius: 8px;
         margin-top: 20px;
     }

     #cart-content .cart-summary h5 {
         font-weight: 600;
         color: #333;
         font-size: 1.1rem;
         margin-bottom: 10px;
     }

     #cart-content .cart-summary .total-label {
         font-size: 0.9rem;
         color: #495057;
     }

     #cart-content .cart-summary .total {
         font-size: 1.2rem;
         font-weight: 700;
     }

     #cart-content .btn-checkout {
         background-color: #1a73e8;
         border-color: #1a73e8;
         border-radius: 4px;
         padding: 8px 20px;
         font-size: 1rem;
         font-weight: 500;
         transition: all 0.3s ease;
         width: 100%;
     }

     #cart-content .btn-checkout:hover {
         background-color: #0056b3;
         border-color: #0056b3;
     }

     #cart-content .empty-cart {
         text-align: center;
         padding: 50px 20px;
         background-color: #fff;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         margin-top: 20px;
         margin-bottom: 20px;
     }

     #cart-content .empty-cart i {
         font-size: 3rem;
         color: #6c757d;
         margin-bottom: 15px;
     }

     #cart-content .empty-cart h4 {
         font-size: 1.3rem;
         font-weight: 500;
         color: #333;
         margin-bottom: 10px;
     }

     #cart-content .empty-cart p {
         font-size: 0.9rem;
         color: #6c757d;
         margin-bottom: 20px;
     }

     #cart-content .empty-cart .btn-primary {
         background-color: #1a73e8;
         border-color: #1a73e8;
         border-radius: 4px;
         padding: 8px 20px;
         font-size: 0.9rem;
         font-weight: 500;
         transition: all 0.3s ease;
     }

     #cart-content .empty-cart .btn-primary:hover {
         background-color: #0056b3;
         border-color: #0056b3;
     }

     #cart-content .item-divider {
         border: 0;
         border-top: 4px solid #d3d6da;
         margin: 0;
     }

     /* CSS cho Modal */
     #cart-content .modal-dialog {
         max-height: 90vh;
         display: flex;
         flex-direction: column;
     }

     #cart-content .modal-content {
         border-radius: 12px;
         box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
         border: none;
         display: flex;
         flex-direction: column;
         height: 100%;
     }

     #cart-content .modal-header {
         background: linear-gradient(90deg, #1a73e8, #4a90e2);
         color: #fff;
         border-top-left-radius: 12px;
         border-top-right-radius: 12px;
         padding: 15px 20px;
     }

     #cart-content .modal-title {
         font-weight: 600;
         font-size: 1.25rem;
         display: flex;
         align-items: center;
         gap: 8px;
     }

     #cart-content .modal-title i {
         font-size: 1.2rem;
     }

     #cart-content .modal-body {
         padding: 25px;
         background-color: #f8f9fa;
         flex: 1 1 auto;
         overflow-y: auto;
         max-height: calc(90vh - 120px);
     }

     #cart-content .modal-section {
         background-color: #fff;
         border-radius: 8px;
         padding: 15px;
         margin-bottom: 20px;
         box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
     }

     #cart-content .modal-section h6 {
         font-weight: 600;
         color: #333;
         margin-bottom: 15px;
         font-size: 1.1rem;
         display: flex;
         align-items: center;
         gap: 8px;
     }

     #cart-content .modal-section h6 i {
         color: #1a73e8;
         font-size: 1.2rem;
     }

     #cart-content .order-item {
         display: flex;
         align-items: center;
         padding: 12px 0;
         border-bottom: 1px solid #e9ecef;
     }

     #cart-content .order-item:last-child {
         border-bottom: none;
     }

     /* Chỉ áp dụng cho hình ảnh trong modal của giohang.html */
     #cart-content .order-item img {
         width: 50px;
         height: 50px;
         object-fit: cover;
         border-radius: 6px;
         margin-right: 15px;
         border: 1px solid #d3d6da;
     }

     #cart-content .order-item-details {
         flex: 1;
     }

     #cart-content .order-item-details p {
         margin: 0;
         font-size: 0.9rem;
         color: #495057;
     }

     #cart-content .order-item-details p strong {
         font-size: 0.95rem;
         color: #333;
     }

     #cart-content .order-item-price {
         font-weight: 600;
         color: #dc3545;
         font-size: 0.95rem;
         min-width: 100px;
         text-align: right;
     }

     #cart-content .summary-row {
         display: flex;
         justify-content: space-between;
         margin-bottom: 8px;
         font-size: 0.9rem;
         color: #495057;
     }

     #cart-content .summary-row.total {
         font-weight: 700;
         font-size: 1.1rem;
         color: #dc3545;
         border-top: 1px solid #e9ecef;
         padding-top: 10px;
         margin-top: 10px;
     }

     #cart-content .order-summary-divider {
         border: 0;
         border-top: 1px solid #e9ecef;
         margin: 15px 0;
     }

     #cart-content .form-group {
         margin-bottom: 20px;
         position: relative;
     }

     #cart-content .form-group label {
         font-weight: 500;
         color: #333;
         margin-bottom: 6px;
         font-size: 0.95rem;
         display: block;
     }

     #cart-content .form-group input,
     #cart-content .form-group select {
         width: 100%;
         padding: 10px 12px;
         border: 1px solid #ced4da;
         border-radius: 6px;
         font-size: 0.9rem;
         transition: border-color 0.2s ease, box-shadow 0.2s ease;
     }

     #cart-content .form-group input:focus,
     #cart-content .form-group select:focus {
         outline: none;
         border-color: #1a73e8;
         box-shadow: 0 0 6px rgba(26, 115, 232, 0.2);
     }

     #cart-content .form-group .error-message {
         color: #dc3545;
         font-size: 0.8rem;
         margin-top: 5px;
         display: none;
     }

     #cart-content .form-group.invalid .error-message {
         display: block;
     }

     #cart-content .form-group.invalid input,
     #cart-content .form-group.invalid select {
         border-color: #dc3545;
     }

     #cart-content .modal-footer {
         position: sticky;
         bottom: 0;
         z-index: 10;
         background-color: #fff;
         padding: 15px 20px;
         border-top: 1px solid #e9ecef;
         border-bottom-left-radius: 12px;
         border-bottom-right-radius: 12px;
     }

     #cart-content .btn-confirm {
         background-color: #1a73e8;
         border-color: #1a73e8;
         padding: 10px 25px;
         font-weight: 500;
         border-radius: 6px;
         transition: background-color 0.2s ease;
     }

     #cart-content .btn-confirm:hover {
         background-color: #0056b3;
         border-color: #0056b3;
     }

     #cart-content .btn-cancel {
         background-color: #6c757d;
         border-color: #6c757d;
         padding: 10px 25px;
         font-weight: 500;
         border-radius: 6px;
         transition: background-color 0.2s ease;
     }

     #cart-content .btn-cancel:hover {
         background-color: #5a6268;
         border-color: #5a6268;
     }

     /* CSS cho Modal chuyển khoản ngân hàng */
     #cart-content #bankTransferModal .modal-header {
         background: linear-gradient(90deg, #1a73e8, #4a90e2);
         color: #fff;
         border-top-left-radius: 12px;
         border-top-right-radius: 12px;
         padding: 15px 20px;
     }

     #cart-content #bankTransferModal .modal-body {
         padding: 20px;
         background-color: #f8f9fa;
     }

     #cart-content #bankTransferModal .modal-body ul {
         margin-bottom: 20px;
     }

     #cart-content #bankTransferModal .modal-body ul li {
         margin-bottom: 8px;
         font-size: 0.95rem;
     }

     #cart-content #bankTransferModal .modal-footer {
         position: sticky;
         bottom: 0;
         background-color: #fff;
         padding: 15px 20px;
         border-top: 1px solid #e9ecef;
         border-bottom-left-radius: 12px;
         border-bottom-right-radius: 12px;
     }

     /* Responsive */
     @media (max-width: 768px) {
         #cart-content .cart-item {
             flex-direction: column;
             align-items: flex-start;
             padding: 10px 0;
         }

         #cart-content .cart-item-left {
             width: 100%;
         }

         #cart-content .cart-item-right {
             width: 100%;
             align-items: flex-start;
             margin-top: 10px;
             margin-left: 0;
         }

         #cart-content .cart-item img {
             width: 72px;
             height: 72px;
             margin-right: 10px;
             border: 2px solid #d3d6da;
             padding: 2px;
             border-radius: 8px;
         }

         #cart-content .cart-item-details {
             width: 100%;
         }

         #cart-content .cart-item-price,
         #cart-content .unit-price {
             text-align: left;
         }

         #cart-content .quantity-selector {
             width: 90px;
             height: 28px;
         }

         #cart-content .quantity-selector button {
             padding: 0 8px;
             font-size: 0.9rem;
         }

         #cart-content .quantity-selector input {
             width: 25px;
             font-size: 0.9rem;
         }

         #cart-content .unit-selector {
             height: 28px;
             font-size: 0.8rem;
         }

         #cart-content .cart-header {
             flex-direction: column;
             align-items: flex-start;
         }

         #cart-content .cart-header .clear-cart {
             margin-top: 10px;
         }

         #cart-content .empty-cart {
             padding: 40px 15px;
         }

         #cart-content .empty-cart i {
             font-size: 2.5rem;
         }

         #cart-content .empty-cart h4 {
             font-size: 1.2rem;
         }

         #cart-content .modal-dialog {
             margin: 10px;
         }

         #cart-content .modal-body {
             padding: 15px;
         }

         #cart-content .modal-section {
             padding: 10px;
         }

         #cart-content .order-item img {
             width: 40px;
             height: 40px;
         }

         #cart-content .order-item-details p {
             font-size: 0.85rem;
         }

         #cart-content .order-item-price {
             font-size: 0.9rem;
         }

         #cart-content .modal-footer {
             flex-direction: column;
             gap: 10px;
         }

         #cart-content .modal-footer .btn {
             width: 100%;
         }
     }

 </style></head>
<body>
<div th:replace="~{giaodien/header :: header}"></div>
<div th:replace="~{giaodien/dropdowns :: dropdowns}"></div>

<main>
    <div class="container mt-4">
        <nav style="--bs-breadcrumb-divider: '/';" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" style="text-decoration: none; color: #1a73e8;">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Giỏ hàng</li>
            </ol>
        </nav>

        <div id="cart-content">
            <!-- Khi có sản phẩm -->
            <div class="cart-container" id="cart-items-container" th:unless="${cartItems == null or #lists.isEmpty(cartItems)}">
                <div class="row">
                    <!-- Danh sách sản phẩm (bên trái) -->
                    <div class="col-lg-8 col-md-12">
                        <div class="cart-header">
                            <h3>
                                <input type="checkbox" id="select-all" checked>
                                <label for="select-all">Chọn tất cả (<span th:text="${cartItems != null ? cartItems.size() : 0}"></span>)</label>
                            </h3>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div th:each="item, iterStat : ${cartItems}">
                            <div class="cart-item">
                                <div class="cart-item-left">
                                    <input type="checkbox" th:id="'item-checkbox-' + ${item.id}" th:data-product-id="${item.book.id}" th:data-unit-id="${item.donViGia?.id}" checked>
                                    <img th:src="${item.book.mainImageUrl != null ? item.book.mainImageUrl : '/images/placeholder.png'}" alt="Book Image" style="margin-left: 20px">
                                    <div class="cart-item-details">
                                        <h6 th:text="${item.book.tenSach} ?: 'Sản phẩm không xác định'"></h6>
                                        <div class="cart-item-actions d-flex align-items-center gap-2">
                                            <div class="quantity-selector">
                                                <button th:onclick="'decreaseQuantity(' + ${item.book.id} + ',' + ${item.donViGia?.id} + ')'">−</button>
                                                <input type="text" th:id="'quantity-' + ${item.book.id} + '-' + ${item.donViGia?.id}" th:value="${item.quantity}" readonly>
                                                <button th:onclick="'increaseQuantity(' + ${item.book.id} + ',' + ${item.donViGia?.id} + ')'">+</button>
                                            </div>
                                            <select class="unit-selector" th:id="'unit-' + ${item.book.id} + '-' + ${item.donViGia?.id}">
                                                <option th:value="${item.donViGia?.id}" th:text="${item.donViGia?.donVi} ?: 'N/A'" selected></option>
                                                <!-- Thêm các tùy chọn khác nếu cần -->
                                            </select>
                                            <button class="btn-remove" th:onclick="'removeItem(' + ${item.id} + ')'">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <p class="discount-info" th:if="${item.donViGia?.discount != null and item.donViGia.discount > 0}">
                                            Giảm ngay <span th:text="${item.donViGia.discount} + '%'"></span>, áp dụng đến 30/04
                                        </p>
                                    </div>
                                </div>
                                <div class="cart-item-right">
                                    <p class="unit-price mb-0" th:id="'unit-price-' + ${item.book.id} + '-' + ${item.donViGia?.id}" th:text="${#numbers.formatDecimal(item.price, 0, 0)} + 'đ'"></p>
                                    <div class="cart-item-price" th:id="'price-' + ${item.book.id} + '-' + ${item.donViGia?.id}" th:text="${#numbers.formatDecimal(item.itemTotalPrice, 0, 0)} + 'đ'"></div>
                                </div>
                            </div>
                            <hr class="item-divider" th:unless="${iterStat.last}"/>
                        </div>

                        <!-- Thông báo lỗi nếu có -->
                        <div th:if="${error != null}" class="alert alert-danger mt-3" th:text="${error}"></div>
                    </div>

                    <!-- Tổng cộng (bên phải) -->
                    <div class="col-lg-4 col-md-12">
                        <div class="cart-summary">
                            <h5>Tổng cộng</h5>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Tổng tiền:</span>
                                <span class="total" id="cart-total" th:text="${#numbers.formatDecimal(cartTotal, 0, 0)} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Giảm giá trực tiếp:</span>
                                <span class="total" id="direct-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(directDiscount, 0, 0)} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Giảm giá voucher:</span>
                                <span class="total" id="voucher-discount" style="color: #f7941d;" th:text="'-' + ${#numbers.formatDecimal(voucherDiscount, 0, 0)} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="total-label">Tiết kiệm được:</span>
                                <span class="total" id="total-savings" style="color: #f7941d;" th:text="${#numbers.formatDecimal(totalSavings, 0, 0)} + 'đ'"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="total-label">Thanh toán:</span>
                                <span class="total" id="final-total" th:text="${#numbers.formatDecimal(finalTotal, 0, 0)} + 'đ'"></span>
                            </div>
                            <div>
                                <button class="btn btn-checkout" data-bs-toggle="modal" data-bs-target="#checkoutModal">Mua hàng</button>
                            </div>
                            <p class="text-muted mt-2 small">
                                Bằng việc tiến hành đặt mua hàng, bạn đồng ý với
                                <a href="#" style="color: #1a73e8; text-decoration: none;">Điều khoản dịch vụ</a> và
                                <a href="#" style="color: #1a73e8; text-decoration: none;">Chính sách xử lý dữ liệu cá nhân</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Khi giỏ hàng trống -->
            <div class="empty-cart" id="empty-cart" th:if="${cartItems == null or #lists.isEmpty(cartItems)}">
                <i class="bi bi-cart-x"></i>
                <h4>Giỏ hàng của bạn đang trống</h4>
                <p>Hãy thêm sản phẩm để tiếp tục mua sắm!</p>
                <a href="/" class="btn btn-primary">Quay lại trang chủ</a>
            </div>

            <!-- Modal Mua hàng -->
            <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="checkoutModalLabel">
                                <i class="bi bi-cart-check"></i> Xác nhận đơn hàng
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Thông tin đơn hàng -->
                            <div class="modal-section">
                                <h6><i class="bi bi-box-seam"></i> Thông tin đơn hàng</h6>
                                <div id="modal-order-items">
                                    <!-- Danh sách sản phẩm sẽ được thêm bằng JavaScript -->
                                </div>
                                <hr class="order-summary-divider">
                                <div class="summary-row">
                                    <span>Tổng tiền:</span>
                                    <span id="modal-cart-total"></span>
                                </div>
                                <div class="summary-row">
                                    <span>Giảm giá trực tiếp:</span>
                                    <span id="modal-direct-discount" style="color: #f7941d;"></span>
                                </div>
                                <div class="summary-row">
                                    <span>Giảm giá voucher:</span>
                                    <span id="modal-voucher-discount" style="color: #f7941d;"></span>
                                </div>
                                <div class="summary-row">
                                    <span>Tiết kiệm được:</span>
                                    <span id="modal-total-savings" style="color: #f7941d;"></span>
                                </div>
                                <div class="summary-row total">
                                    <span>Thanh toán:</span>
                                    <span id="modal-final-total"></span>
                                </div>
                            </div>

                            <!-- Thông tin khách hàng -->
                            <div class="modal-section">
                                <h6><i class="bi bi-person"></i> Thông tin khách hàng</h6>
                                <div class="form-group">
                                    <label for="customer-name">Họ và tên <span style="color: #dc3545;">*</span></label>
                                    <input type="text" id="customer-name" class="form-control" placeholder="Nhập họ và tên">
                                    <div class="error-message">Vui lòng nhập họ và tên.</div>
                                </div>
                                <div class="form-group">
                                    <label for="customer-phone">Số điện thoại <span style="color: #dc3545;">*</span></label>
                                    <input type="tel" id="customer-phone" class="form-control" placeholder="Nhập số điện thoại">
                                    <div class="error-message">Vui lòng nhập số điện thoại hợp lệ.</div>
                                </div>
                                <div class="form-group">
                                    <label for="customer-address">Địa chỉ giao hàng <span style="color: #dc3545;">*</span></label>
                                    <input type="text" id="customer-address" class="form-control" placeholder="Nhập địa chỉ giao hàng">
                                    <div class="error-message">Vui lòng nhập địa chỉ giao hàng.</div>
                                </div>
                            </div>

                            <!-- Phương thức thanh toán -->
                            <div class="modal-section">
                                <h6><i class="bi bi-credit-card"></i> Phương thức thanh toán</h6>
                                <div class="form-group">
                                    <label for="payment-method">Chọn phương thức</label>
                                    <select id="payment-method" class="form-control">
                                        <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                                        <option value="bank">Chuyển khoản ngân hàng</option>
                                        <option value="payos">Thanh toán qua PayOS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-confirm" id="confirm-order">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{giaodien/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    // Hàm định dạng giá tiền
    function formatPrice(price) {
        if (isNaN(price) || price === null) {
            return '0đ';
        }
        return parseFloat(price).toLocaleString('vi-VN') + 'đ';
    }

    // Cập nhật giá sản phẩm
    function updatePrice(bookId, donViGiaId, quantity) {
        let unitPriceText = $('#unit-price-' + bookId + '-' + donViGiaId).text().replace(/[^0-9]/g, '');
        let unitPrice = parseFloat(unitPriceText);

        let totalPrice = unitPrice * quantity;
        $('#price-' + bookId + '-' + donViGiaId).text(formatPrice(totalPrice));

        updateCartSummary();
        updateCheckoutModal();

        $.ajax({
            url: '/cart/update-quantity',
            type: 'POST',
            headers: {
                [$('meta[name="_csrf_header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
            },
            data: { productId: bookId, donViTinhId: donViGiaId, quantity: quantity },
            success: function(response) {
                if (response.success) {
                    let unitPrice = response.price;
                    $('#unit-price-' + bookId + '-' + donViGiaId).text(formatPrice(unitPrice));

                    let totalPrice = unitPrice * quantity;
                    $('#price-' + bookId + '-' + donViGiaId).text(formatPrice(totalPrice));

                    updateCartSummary();
                    updateCheckoutModal();
                }
            },
            error: function(xhr) {
                console.error('Error updating quantity:', xhr);
            }
        });
    }

    // Cập nhật tổng giỏ hàng
    function updateCartSummary() {
        let total = 0;
        let directDiscount = 0;
        let voucherDiscount = parseFloat($('#voucher-discount').text().replace(/[^0-9]/g, '')) || 0;

        $('input[id^="item-checkbox-"]').each(function() {
            if ($(this).is(':checked')) {
                let bookId = $(this).data('product-id');
                let unitId = $(this).data('unit-id');
                let quantity = parseInt($('#quantity-' + bookId + '-' + unitId).val());
                let priceText = $('#price-' + bookId + '-' + unitId).text().replace(/[^0-9]/g, '');
                let itemTotalPrice = parseFloat(priceText);

                total += itemTotalPrice;
            }
        });

        directDiscount = parseFloat($('#direct-discount').text().replace(/[^0-9]/g, '')) || 0;
        let totalSavings = directDiscount + voucherDiscount;
        let finalTotal = total - totalSavings;

        $('#cart-total').text(formatPrice(total));
        $('#direct-discount').text('-' + formatPrice(directDiscount));
        $('#voucher-discount').text('-' + formatPrice(voucherDiscount));
        $('#total-savings').text(formatPrice(totalSavings));
        $('#final-total').text(formatPrice(finalTotal));
    }

    // Cập nhật modal thanh toán
    function updateCheckoutModal() {
        let total = 0;
        let itemsHtml = '';

        $('input[id^="item-checkbox-"]').each(function() {
            if ($(this).is(':checked')) {
                let bookId = $(this).data('product-id');
                let unitId = $(this).data('unit-id');
                let quantity = parseInt($('#quantity-' + bookId + '-' + unitId).val());
                let unitPriceText = $('#unit-price-' + bookId + '-' + unitId).text().replace(/[^0-9]/g, '');
                let unitPrice = parseFloat(unitPriceText);
                let priceText = $('#price-' + bookId + '-' + unitId).text().replace(/[^0-9]/g, '');
                let itemTotalPrice = parseFloat(priceText);
                let bookName = $(this).closest('.cart-item').find('h6').text();
                let unitName = $('#unit-' + bookId + '-' + unitId + ' option:selected').text();
                let bookImage = $(this).closest('.cart-item').find('img').attr('src');

                total += itemTotalPrice;

                itemsHtml += `
                    <div class="order-item">
                        <img src="${bookImage}" alt="${bookName}">
                        <div class="order-item-details">
                            <p><strong>${bookName}</strong></p>
                            <p>Số lượng: ${quantity} | Đơn vị: ${unitName} | Giá: ${formatPrice(unitPrice)}</p>
                        </div>
                        <div class="order-item-price">${formatPrice(itemTotalPrice)}</div>
                    </div>
                `;
            }
        });

        let directDiscount = parseFloat($('#direct-discount').text().replace(/[^0-9]/g, '')) || 0;
        let voucherDiscount = parseFloat($('#voucher-discount').text().replace(/[^0-9]/g, '')) || 0;
        let totalSavings = directDiscount + voucherDiscount;
        let finalTotal = total - totalSavings;

        $('#modal-order-items').html(itemsHtml);
        $('#modal-cart-total').text(formatPrice(total));
        $('#modal-direct-discount').text('-' + formatPrice(directDiscount));
        $('#modal-voucher-discount').text('-' + formatPrice(voucherDiscount));
        $('#modal-total-savings').text(formatPrice(totalSavings));
        $('#modal-final-total').text(formatPrice(finalTotal));
    }

    // Tăng số lượng
    function increaseQuantity(bookId, donViGiaId) {
        let input = $('#quantity-' + bookId + '-' + donViGiaId);
        let quantity = parseInt(input.val()) + 1;
        input.val(quantity);
        updatePrice(bookId, donViGiaId, quantity);
    }

    // Giảm số lượng
    function decreaseQuantity(bookId, donViGiaId) {
        let input = $('#quantity-' + bookId + '-' + donViGiaId);
        let quantity = parseInt(input.val());
        if (quantity > 1) {
            quantity -= 1;
            input.val(quantity);
            updatePrice(bookId, donViGiaId, quantity);
        }
    }

    // Xóa sản phẩm
    function removeItem(cartItemId) {
        if (confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
            $.ajax({
                url: '/cart/remove',
                type: 'POST',
                headers: {
                    [$('meta[name="_csrf_header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
                },
                data: { cartItemId: cartItemId },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Xóa sản phẩm thất bại: ' + response.message);
                    }
                },
                error: function(xhr) {
                    console.error('Error removing item:', xhr);
                    alert('Đã có lỗi xảy ra khi xóa sản phẩm.');
                }
            });
        }
    }

    // Xóa toàn bộ giỏ hàng
    function clearCart() {
        if (confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?')) {
            $.ajax({
                url: '/cart/clear',
                type: 'POST',
                headers: {
                    [$('meta[name="_csrf_header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Xóa giỏ hàng thất bại: ' + response.message);
                    }
                },
                error: function(xhr) {
                    console.error('Error clearing cart:', xhr);
                    alert('Đã có lỗi xảy ra khi xóa giỏ hàng.');
                }
            });
        }
    }

    // Kiểm tra giỏ hàng rỗng
    function checkCartEmpty(itemCount) {
        if (itemCount === 0) {
            $('#cart-items-container').hide();
            $('#empty-cart').show();
            $('.btn-checkout').prop('disabled', true);
        } else {
            $('#cart-items-container').show();
            $('#empty-cart').hide();
            $('.btn-checkout').prop('disabled', false);
        }
    }

    $(document).ready(function() {
        let initialItemCount = /*[[${cartItems != null ? cartItems.size() : 0}]]*/ 0;
        checkCartEmpty(initialItemCount);

        // Định dạng giá ban đầu
        $('p[id^="unit-price-"]').each(function() {
            let price = parseFloat($(this).text().replace(/[^0-9]/g, ''));
            $(this).text(formatPrice(price));
        });
        $('div[id^="price-"]').each(function() {
            let price = parseFloat($(this).text().replace(/[^0-9]/g, ''));
            $(this).text(formatPrice(price));
        });

        updateCartSummary();
        updateCheckoutModal();

        // Xử lý chọn tất cả
        $('#select-all').on('change', function() {
            let isChecked = $(this).is(':checked');
            $('input[id^="item-checkbox-"]').prop('checked', isChecked);
            updateCartSummary();
            updateCheckoutModal();
        });

        // Xử lý chọn từng sản phẩm
        $('input[id^="item-checkbox-"]').on('change', function() {
            let allChecked = $('input[id^="item-checkbox-"]').length === $('input[id^="item-checkbox-"]:checked').length;
            $('#select-all').prop('checked', allChecked);
            updateCartSummary();
            updateCheckoutModal();
        });

        // Xử lý khi mở modal
        $('#checkoutModal').on('show.bs.modal', function() {
            updateCheckoutModal();

            // Kiểm tra nếu không có sản phẩm nào được chọn
            let selectedItems = $('input[id^="item-checkbox-"]:checked').length;
            if (selectedItems === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm để mua hàng.');
                return false; // Ngăn modal mở
            }

            // Reset trạng thái form
            $('.form-group').removeClass('invalid');
            $('#customer-name, #customer-phone, #customer-address').val('');
        });

        // Xử lý xác nhận đơn hàng
        $('#confirm-order').on('click', function() {
            let customerName = $('#customer-name').val().trim();
            let customerPhone = $('#customer-phone').val().trim();
            let customerAddress = $('#customer-address').val().trim();
            let paymentMethod = $('#payment-method').val();

            // Reset trạng thái lỗi
            $('.form-group').removeClass('invalid');

            // Kiểm tra thông tin khách hàng
            let isValid = true;
            if (!customerName) {
                $('#customer-name').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!customerPhone || !/^\d{10,11}$/.test(customerPhone)) {
                $('#customer-phone').closest('.form-group').addClass('invalid');
                isValid = false;
            }
            if (!customerAddress) {
                $('#customer-address').closest('.form-group').addClass('invalid');
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // Thu thập danh sách sản phẩm đã chọn
            let selectedItems = [];
            let totalAmount = 0;
            $('input[id^="item-checkbox-"]:checked').each(function() {
                let bookId = $(this).data('product-id');
                let unitId = $(this).data('unit-id');
                let quantity = parseInt($('#quantity-' + bookId + '-' + unitId).val());
                let priceText = $('#price-' + bookId + '-' + unitId).text().replace(/[^0-9]/g, '');
                let itemTotalPrice = parseFloat(priceText);
                totalAmount += itemTotalPrice;

                selectedItems.push({
                    productId: bookId,
                    donViTinhId: unitId,
                    quantity: quantity,
                    price: itemTotalPrice / quantity
                });
            });

            // Chuẩn bị dữ liệu đơn hàng
            let orderData = {
                customerName: customerName,
                customerPhone: customerPhone,
                customerAddress: customerAddress,
                paymentMethod: paymentMethod,
                items: selectedItems,
                totalAmount: totalAmount
            };

            if (paymentMethod === 'payos') {
                // Xử lý thanh toán qua PayOS
                $.ajax({
                    url: '/thanhtoan/payos',
                    type: 'POST',
                    headers: {
                        [$('meta[name="_csrf_header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
                    },
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    success: function(response) {
                        if (response.success && response.checkoutUrl) {
                            window.location.href = response.checkoutUrl;
                        } else {
                            alert('Không thể tạo link thanh toán: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error creating PayOS payment:', xhr);
                        alert('Đã có lỗi xảy ra khi tạo link thanh toán.');
                    }
                });
            } else {
                // Xử lý các phương thức thanh toán khác (COD, bank)
                $.ajax({
                    url: '/thanhtoan',
                    type: 'POST',
                    headers: {
                        [$('meta[name="_csrf_header"]').attr('content')]: $('meta[name="_csrf"]').attr('content')
                    },
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    success: function(response) {
                        if (response.success) {
                            alert('Đặt hàng thành công!');
                            window.location.href = '/order-confirmation';
                        } else {
                            alert('Đặt hàng thất bại: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error placing order:', xhr);
                        alert('Đã có lỗi xảy ra. Vui lòng thử lại sau.');
                    }
                });
            }

            $('#checkoutModal').modal('hide');
        });
    });
</script>
</body>
</html>