<div th:fragment="dropdowns">
  <link rel="stylesheet" href="/css/dropdowns.css">

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav" id="category-list">
          <!-- Danh mục sẽ được render động bằng JavaScript -->
        </ul>
      </div>
    </div>
  </nav>

  <!-- Template cho mỗi dropdown -->
  <script type="text/template" id="category-template">
    <li class="nav-item dropdown">
      <a class="nav-link dropdown-toggle" href="#" role="button">{categoryName}</a>
      <div class="dropdown-menu">
        <div class="menu-right">
          <div class="menu-category">Sách nổi bật</div>
          <div class="product-grid" data-category-id="{categoryId}">
            <!-- Sách nổi bật sẽ được render động -->
          </div>
        </div>
      </div>
    </li>
  </script>

  <!-- Template cho mỗi sản phẩm -->
  <script type="text/template" id="product-template">
    <div class="product">
      <img src="{imageUrl}" alt="">
      <div>{bookName}<br>{price}</div>
    </div>
  </script>

  <script>
    // Hàm thay thế dữ liệu vào template
    function renderTemplate(templateId, data) {
      let template = document.getElementById(templateId).innerText;
      for (const key in data) {
        template = template.replace(`{${key}}`, data[key]);
      }
      return template;
    }

    // Lấy danh sách danh mục
    fetch('/api/quanly/categories')
            .then(response => {
              if (!response.ok) {
                throw new Error('Lỗi khi lấy danh mục: ' + response.status);
              }
              return response.json();
            })
            .then(categories => {
              const categoryList = document.getElementById('category-list');
              categories.forEach(category => {
                // Kiểm tra category.id có tồn tại
                if (!category.id) {
                  console.error('Danh mục không có id:', category);
                  return;
                }

                // Render dropdown cho mỗi danh mục
                const categoryHtml = renderTemplate('category-template', {
                  categoryName: category.tenDanhMuc || 'Không có tên',
                  categoryId: category.id
                });
                categoryList.insertAdjacentHTML('beforeend', categoryHtml);

                // Lấy sách nổi bật cho danh mục
                fetch(`/book/featured-books?danhMucId=${category.id}`)
                        .then(response => {
                          if (!response.ok) {
                            throw new Error('Lỗi khi lấy sách nổi bật: ' + response.status);
                          }
                          return response.json();
                        })
                        .then(books => {
                          const productGrid = document.querySelector(`.product-grid[data-category-id="${category.id}"]`);
                          if (!productGrid) {
                            console.error('Không tìm thấy product-grid cho danh mục:', category.id);
                            return;
                          }

                          if (books.length === 0) {
                            productGrid.innerHTML = '<div>Chưa có sách nổi bật</div>';
                            return;
                          }

                          books.forEach(book => {
                            const mainImage = book.bookImages && book.bookImages.find(img => img.isMain) || { imageUrl: '/images/placeholder.png' };
                            const donViGia = book.donViGias && book.donViGias[0] || { gia: 0 };
                            const productHtml = renderTemplate('product-template', {
                              imageUrl: mainImage.imageUrl,
                              bookName: book.tenSach || 'Không có tên',
                              price: donViGia.gia ? donViGia.gia.toLocaleString('vi-VN') + 'đ' : 'Liên hệ'
                            });
                            productGrid.insertAdjacentHTML('beforeend', productHtml);
                          });
                        })
                        .catch(error => {
                          console.error(`Lỗi khi lấy sách nổi bật cho danh mục ${category.id}:`, error);
                          const productGrid = document.querySelector(`.product-grid[data-category-id="${category.id}"]`);
                          if (productGrid) {
                            productGrid.innerHTML = '<div>Lỗi khi tải sách</div>';
                          }
                        });
              });
            })
            .catch(error => {
              console.error('Lỗi khi lấy danh mục:', error);
              document.getElementById('category-list').innerHTML = '<li>Lỗi khi tải danh mục</li>';
            });
  </script>
</div>