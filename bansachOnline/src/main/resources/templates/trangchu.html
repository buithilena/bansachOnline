<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Home Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="icon" type="image/png" th:href="@{/image/logo.png}">
    <df-messenger
            intent="WELCOME"
            chat-title="Test_AI_chat"
            agent-id="64771957-faf8-423e-8e98-bf9a7d0906e4"
            language-code="en"
    ></df-messenger>
    <link rel="stylesheet" href="/css/trangchu.css">


</head>
<body>
<!-- Import Header -->
<div th:replace="~{giaodien/header :: header}"></div>
<div th:replace="~{giaodien/dropdowns :: dropdowns}"></div>
<div th:replace="~{giaodien/hero-section :: hero-section}"></div>

<main>
    <div style="display: flex; justify-content: center; margin-top: 20px">
        <img src="/image/nentrang.png" alt="BookStore Logo" class="me-2"
             style="width: 100%; max-width: 400px; height: auto;">
    </div>

    <!-- Hiển thị danh sách sách -->
    <div class="container mt-4">
        <h4 class="mb-3">Danh sách sản phẩm</h4>
        <div class="product-scroll-container">
            <div class="product-list">
                <div class="product-card" th:each="product : ${books}">
                    <div class="card border rounded shadow-sm d-flex flex-column h-100">
        <span class="badge bg-danger position-absolute discount-badge"
              th:id="'discount-badge-' + ${product.id}"
              th:style="${product.hasDiscount()} ? '' : 'display: none;'"
              th:text="'-' + ${#numbers.formatDecimal(product.getDefaultDonViTinh().discount, 0, 0)} + '%'"></span>
                        <img th:src="${product.mainImageUrl ?: '/images/placeholder.png'}" class="card-img-top" th:alt="${product.tenSach}">
                        <div class="card-body text-center d-flex flex-column">
                            <a th:href="@{/book/sanpham(id=${product.id})}" class="card-title text-decoration-none">
                                <h6 th:text="${product.tenSach}"></h6>
                            </a>
                            <div class="price-section">
                                <div th:id="'discounted-price-' + ${product.id}" class="discounted-price"
                                     th:data-price="${product.getDiscountedPrice()}"
                                     th:text="${#numbers.formatDecimal(product.getDiscountedPrice(), 0, 0)} + 'đ'"></div>
                                <div th:id="'original-price-' + ${product.id}" class="original-price"
                                     th:style="${product.hasDiscount()} ? '' : 'display: none;'"
                                     th:data-price="${product.getDefaultDonViTinh().gia}"
                                     th:text="${#numbers.formatDecimal(product.getDefaultDonViTinh().gia, 0, 0)} + 'đ'"></div>
                            </div>
                            <button class="btn btn-primary w-100 mt-auto"
                                    th:onclick="'addToCart(' + ${product.id} + ')'">
                                Chọn mua
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Thông báo nếu không có sản phẩm -->
                <div class="text-center text-muted" th:unless="${books != null and not #lists.isEmpty(books)}">
                    Hiện tại chưa có sản phẩm nào.
                </div>
            </div>
        </div>

        <!-- Phân trang -->
        <nav aria-label="Page navigation" class="mt-4" th:if="${totalPages > 1}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/(page=${currentPage - 1})}">Previous</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/(page=${i})}" th:text="${i + 1}"></a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/(page=${currentPage + 1})}">Next</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Phần sách yêu thích (giữ nguyên) -->
    <div class="container py-4">
        <div class="d-flex align-items-center" style="margin: 10px">
            <img src="/image/img_15.png" class="icon-img me-2" height="32px" width="32px" alt="Icon">
            <h4 class="mb-0 title-text">Sách yêu thích</h4>
        </div>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 g-3">
            <div class="col">
                <div class="card text-center">
                    <img src="/image/img_4.png" class="card-img-top" alt="Book">
                    <div class="brand-logo-container">
                        <img src="/image/img_10.png" class="brand-logo" alt="Publisher">
                    </div>
                    <div class="card-body">
                        <p class="text-primary">Giảm đến 35%</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center">
                    <img src="/image/img_5.png" class="card-img-top" alt="Book">
                    <div class="brand-logo-container">
                        <img src="/image/img_14.png" class="brand-logo" alt="Publisher">
                    </div>
                    <div class="card-body">
                        <p class="text-primary">Giảm đến 30%</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center">
                    <img src="/image/img_6.png" class="card-img-top" alt="Book">
                    <div class="brand-logo-container">
                        <img src="/image/img_13.png" class="brand-logo" alt="Publisher">
                    </div>
                    <div class="card-body">
                        <p class="text-primary">Giảm đến 20%</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center">
                    <img src="/image/img_7.png" class="card-img-top" alt="Book">
                    <div class="brand-logo-container">
                        <img src="/image/img_12.png" class="brand-logo" alt="Publisher">
                    </div>
                    <div class="card-body">
                        <p class="text-primary">Voucher giảm đến 30%</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card text-center">
                    <img src="/image/img_8.png" class="card-img-top" alt="Book">
                    <div class="brand-logo-container">
                        <img src="/image/img_11.png" class="brand-logo" alt="Publisher">
                    </div>
                    <div class="card-body">
                        <p class="text-primary">Giảm đến 20%</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Import Footer -->
<div th:replace="~{giaodien/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    function addToCart(bookId) {
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: '/cart/add',
            type: 'POST',
            headers: {
                [header]: token // Thêm CSRF token vào header
            },
            data: {
                productId: bookId,
                donViTinhId: 0,
                quantity: 1
            },
            success: function(response) {
                if (response.success) {
                    Toastify({
                        text: "Đã thêm sản phẩm vào giỏ hàng!",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#28a745",
                        stopOnFocus: true
                    }).showToast();

                    $('.cart-count').text(response.cartItemCount);
                } else {
                    Toastify({
                        text: response.message || "Lỗi khi thêm sản phẩm vào giỏ hàng!",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#dc3545",
                        stopOnFocus: true
                    }).showToast();
                }
            },
            error: function(xhr, status, error) {
                Toastify({
                    text: "Lỗi khi thêm sản phẩm: " + xhr.responseText,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                }).showToast();
            }
        });
    }

    function updatePrice(bookId, donViGiaId) {
        $.ajax({
            url: '/book/update-price',
            type: 'GET',
            data: { bookId: bookId, donViGiaId: donViGiaId },
            success: function(response) {
                $('#discounted-price-' + bookId).text(Number(response.discountedPrice).toLocaleString('vi-VN') + 'đ');
                if (response.hasDiscount) {
                    $('#original-price-' + bookId).text(Number(response.gia).toLocaleString('vi-VN') + 'đ').show();
                    $('#discount-badge-' + bookId).text('-' + Number(response.discount) + '%').show();
                } else {
                    $('#original-price-' + bookId).hide();
                    $('#discount-badge-' + bookId).hide();
                }
                $('.unit-btn-group button').removeClass('active');
                $('#unit-btn-' + bookId + '-' + donViGiaId).addClass('active');
            },
            error: function(xhr, status, error) {
                console.error('Lỗi khi cập nhật giá:', error);
            }
        });
    }
</script>


</body>
</html>